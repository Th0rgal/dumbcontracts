---
title: Add a Contract
---

# Add a Contract (Spec → Proof → Compiler → Tests)

This is the shortest reliable path to add a new contract end-to-end, anchored to SimpleStorage.

## Checklist

1. Spec
- Define the contract interface and storage in `DumbContracts/Specs/SimpleStorage.lean`.
- Keep function signatures aligned with Solidity types and storage slots.

2. EDSL Example
- Implement the contract logic in `DumbContracts/Examples/SimpleStorage.lean`.
- Reuse helper lemmas for storage updates and mapping reads when possible.

3. Layer 1 Proofs
- Prove correctness in `DumbContracts/Specs/SimpleStorage/Proofs.lean`.
- Each theorem should state the observable behavior (return values + storage deltas).

4. Compiler Spec + Proofs (Layer 2)
- Add compiler-level spec in `Compiler/Specs.lean`.
- Prove `ContractSpec → IR` preservation in `Compiler/Proofs/IRGeneration/SimpleStorageProof.lean`.

5. Differential Tests
- Add a diff test harness in `test/DifferentialSimpleStorage.t.sol`.
- Use the shared knobs in `test/DiffTestConfig.sol` for sharding and random counts.
- Add any edge-value tests using `_edgeUintValues()`.

6. Property Tests (Proofs → Tests)
- Register lemma names in `test/property_manifest.json`.
- Add matching Foundry tests in `test/InvariantSimpleStorage.t.sol`.
- Keep the manifest in sync with `scripts/check_property_manifest.py`.

## Expected File Layout

- `DumbContracts/Specs/<YourContract>.lean`
- `DumbContracts/Examples/<YourContract>.lean`
- `DumbContracts/Specs/<YourContract>/Proofs.lean`
- `Compiler/Proofs/IRGeneration/<YourContract>Proof.lean`
- `test/Differential<YourContract>.t.sol`
- `test/Invariant<YourContract>.t.sol`

## Common Pitfalls

- Storage slot mismatches between spec and Yul output.
- Missing selector updates when adding functions.
- Mapping conversions not mirrored in proofs.
- Property tags drifting from lemma names.

## Done When

- `lake build` passes.
- `forge test --match-contract Differential` passes locally.
- Property checks pass: `python3 scripts/check_property_manifest.py` and `python3 scripts/check_property_coverage.py`.
