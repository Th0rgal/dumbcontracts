# Research Log

## 2026-02-10
- Added `requireNonZeroAndLt` stdlib helper for combined nonzero + max guards.
- Refactored `setIfNonZeroAndLess` to use `requireNonZeroAndLt`.
- Added `addIfNonZeroAndLess` example (guarded add on `delta != 0` and `delta < max`) with SpecR + proofs.
- Added Foundry test for `addIfNonZeroAndLess`.
- Updated compiler entries + direct EVM asm for `addIfNonZeroAndLess`.
- Added `sstoreIfEq` stdlib helper for guarded stores on slot equality.
- Refactored `compareAndSwap` to use `sstoreIfEq`.
- Added `clearIfEq` example (clear slot when it matches expected) with SpecR + proofs.
- Added Foundry test for `clearIfEq`.
- Updated compiler entries + direct EVM asm for `clearIfEq`.
- Added `requireZero` stdlib helper for zero guards.
- Refactored `initOnce` to use `requireZero`.
- Added `initToOne` example (initialize slot to `1` when empty) with SpecR + proofs.
- Added Foundry test for `initToOne`.
- Updated compiler entries + direct EVM asm for `initToOne`.
- Added `requireGte` stdlib helper for `>=` guards (via `not lt`).
- Refactored `subIfEnough` to use `requireGte`.
- Added `setIfAtLeast` example (guarded store on `value >= min`) with SpecR + proofs.
- Added Foundry test for `setIfAtLeast`.
- Updated compiler entries + direct EVM asm for `setIfAtLeast`.
- Added `sstoreSub` stdlib helper for slot decrements.
- Refactored `transfer` to use `sstoreSub` for balance subtraction.
- Added `subIfEnough` example (guarded decrement when slot >= delta) with SpecR + proofs.
- Added Foundry test for `subIfEnough`.
- Updated compiler entries + direct EVM asm for `subIfEnough`.
- Added `requireBetween` stdlib helper for strict range guards.
- Refactored `setIfBetween` to use `requireBetween`.
- Added `addIfBetween` example (guarded add on `min < delta < max`) with SpecR + proofs.
- Added Foundry test for `addIfBetween`.
- Updated compiler entries + direct EVM asm for `addIfBetween`.
- Added `sstoreMin` stdlib helper to mirror `sstoreMax` for min updates.
- Added `updateMin` example (monotonic min update against a stored slot) with Spec + proof.
- Added Foundry test for `updateMin`.
- Updated compiler entries + direct EVM asm for `updateMin`.
- Added `sstoreMax` stdlib helper to reduce max-store boilerplate.
- Refactored `maxStore` to use `sstoreMax`.
- Added `updateMax` example (monotonic max update against a stored slot) with Spec + proof.
- Added Foundry test for `updateMax`.
- Updated compiler entries + direct EVM asm for `updateMax`.
- Added `sstoreInc` stdlib helper to increment a slot without repeating `add` boilerplate.
- Refactored `bumpSlot` to use `sstoreInc`.
- Added `bumpIfNonZero` example (guarded increment when slot is nonzero) with SpecR + proofs.
- Added Foundry test for `bumpIfNonZero`.
- Updated compiler entries + direct EVM asm for `bumpIfNonZero`.
- Added `requireAnd` stdlib helper to combine guard conditions cleanly.
- Refactored `setIfBetween` to use `requireAnd` instead of nested guards.
- Added `setIfNonZeroAndLess` example (nonzero + max guard) with SpecR + proofs.
- Added Foundry test for `setIfNonZeroAndLess`.
- Updated compiler entries + direct EVM asm for `setIfNonZeroAndLess`.
- Added `letSload` stdlib helper for caching a slot read via `let_`.
- Refactored `compareAndSwap` to use `letSload`.
- Added `initOnce` example (only initialize a zero slot) with SpecR + proofs.
- Added Foundry test for `initOnce`.
- Updated compiler entries + direct EVM asm for `initOnce`.
- Added `requireLt` stdlib helper to mirror `requireGt` for less-than guards.
- Refactored `setIfLess` to use `requireLt` instead of a manual `revertIf`.
- Added `setIfBetween` example (guarded store on `min < value < max`) with SpecR + proofs.
- Added Foundry test for `setIfBetween`.
- Updated compiler entries + direct EVM asm for `setIfBetween`.
- Added `revertIf` stdlib helper for guard-style reverts.
- Refactored `checkHealth` to use `revertIf`.
- Added `setIfLess` example (guarded store on `value < max`) with SpecR + proofs.
- Added Foundry test for `setIfLess`.
- Updated compiler entries + direct EVM asm for `setIfLess`.
- Added `sstoreAdd` stdlib helper to make slot increments less noisy.
- Added `bumpSlot` example (increment slot by one) with a basic Spec + proof.
- Refactored `addSlot` and `guardedAddSlot` to use `sstoreAdd`.
- Added Foundry test for `bumpSlot`.
- Updated compiler entries + direct EVM asm for `bumpSlot`.
- Added `requireGt` stdlib helper to reduce guard boilerplate.
- Added `setIfGreater` example (guarded store on `value > min`) with SpecR + proofs.
- Refactored `guardedAddSlot` to use `requireGt`.
- Added Foundry test for `setIfGreater`.
- Added `eq`/`neq` plus `requireEq`/`requireNeq` stdlib helpers.
- Added `compareAndSwap` example (guarded store on expected value match) with SpecR and proofs.
- Avoided double `sload` in `compareAndSwap` by caching the slot value with `let_` (prevents false reverts).
- Refactored `setNonZero` to use the new `requireNeq` helper.
- Updated compiler entries + direct EVM asm for `compareAndSwap`.
- Added Foundry test for `compareAndSwap`.

## 2026-02-09
- Added spec-style wrappers for storage and risk examples.
- Added `SpecR` (specs with explicit revert predicates) and proofs.
- Added token-style transfer `SpecR` + proofs (revert on zero address or low balance).
- Added sum-preservation lemma for transfer (distinct accounts).
- Added transfer locality lemma (other balances unchanged).
- Added transfer sum lemma for a list of non-updated accounts.
- Added transfer sum lemma for `(from :: to :: rest)` lists (sum preserved with `from/to` included).
- Added totalSupply slot model + lemma showing transfer does not modify totalSupply.
- Added supply conservation lemma for a tracked list (`from :: to :: rest`) under transfer.
- Added transfer self-case lemma (when `from = to`, exec is a no-op after both writes).
- Added sequential-read transfer spec (`transferSpecRSeq`) to match exec semantics.
- Proved `transferSpecRSeq` meets execution and self-transfer is a no-op under the sequential spec.
- Added a self-transfer counterexample lemma showing `transferSpecR` cannot hold for `from = to` when `amount > 0`.
- Proved sequential transfer spec is equivalent to old-state spec when `from ≠ to`.
- Added a guarded transfer spec (`transferSpecRNoSelf`) and proof it meets execution when `from ≠ to`.
- Added a small counterexample lemma showing list-based supply accounting breaks with duplicates (motivation for sets/dedup).
- Split `Examples.lean` into multiple focused example modules.
- Added a minimal EDSL stdlib with common helpers (`require`, `unless`, `assert`, slot helpers, var/lit helpers).
- Added `sloadVar`/`sstoreVar` stdlib helpers for variable slot access.
- Added a tiny `maxStore` example (store max(a,b) into a slot) plus selector + Foundry test.
- Added a `requireNonZero` helper plus a tiny `setNonZero` example + Foundry test.
- Updated direct EVM asm to include `setNonZero` and force label pushes to `PUSH2` so bytecode matches solc output.
- Refreshed external landscape notes (Act, Scribble, Certora, SMTChecker, KEVM, Kontrol).
- Added selector map artifact (fixed + ABI keccak).
- Fixed Foundry selectors and moved to Shanghai EVM.
- Added Foundry tests for generated contracts.
- Compressed docs + tightened minimal frontend.
- Scanned external tooling landscape (Act, Scribble, Certora, SMTChecker, KEVM/Kontrol, VerX, Move Prover).
# 2026-02-10
- Added `sstoreIfZero` stdlib helper to package the common "load + require zero + store" pattern.
- Refactored `initOnce` and `initToOne` to use `sstoreIfZero`.
- Added `initDouble` example (initialize to `value * 2` on zero) with SpecR + proofs.
- Added Foundry test for `initDouble`.
- Updated compiler entries + direct EVM asm wiring for `initDouble`.
- `end_to_end` initially failed due to direct EVM asm mismatch in `initDouble`; fixed by aligning the stack order (`swap1` prelude + `swap1` before `sstore`) with solc output.
- Ran `PATH=/opt/lean-4.27.0/bin:$PATH lake build`, `./scripts/end_to_end.sh`, and `./scripts/foundry_test_generated.sh` (all green).
- Added `sstoreIfLt` stdlib helper to avoid redundant stores when capping a slot.
- Refactored `updateMin` to use `sstoreIfLt` (skip store when the slot is already below the cap).
- Added `capSlot` example (cap a slot to a maximum without reverting) with Spec + proof.
- Added Foundry test for `capSlot`.
- Updated compiler entries + direct EVM asm wiring for `updateMin` and `capSlot`.
- `end_to_end` initially failed due to direct EVM asm block layout for `capSlot`/`updateMin`; fixed by matching solc's `jump(tag_out)` shape and using `PUSH0` for zero.
- Ran `PATH=/opt/lean-4.27.0/bin:$PATH lake build`, `./scripts/end_to_end.sh`, and `./scripts/foundry_test_generated.sh` (all green).
